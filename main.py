from fastapi import FastAPI, Request, HTTPException
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import openai
import os
import json
import uvicorn

# ç’°å¢ƒå¤‰æ•°ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è¨­å®šï¼‰
LINE_CHANNEL_ACCESS_TOKEN = os.getenv('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.getenv('LINE_CHANNEL_SECRET')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

# LINE Bot APIã®åˆæœŸåŒ–
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# OpenAI APIã®åˆæœŸåŒ–
openai.api_key = OPENAI_API_KEY
client = openai.OpenAI(api_key=OPENAI_API_KEY)

app = FastAPI()

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®è¾æ›¸
user_responses = {}

# é©æ–°çš„10å•ã®è³ªå•è¨­è¨ˆ
QUESTIONS = {
    1: {
        "question": "ğŸ¤” **è³ªå•1/10ã€èªçŸ¥æ§‹é€ ã€‘**\n\næœ€è¿‘ã€é‡è¦ãªæ±ºæ–­ã‚’ã—ãŸä½“é¨“ã«ã¤ã„ã¦ã€ãã®æ™‚ã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’å…·ä½“çš„ã«æ•™ãˆã¦ãã ã•ã„ã€‚ä½•ã‚’è€ƒãˆã€ä½•ã‚’é‡è¦–ã—ã€æœ€çµ‚çš„ã«ã©ã†åˆ¤æ–­ã—ãŸã‹ã‚’è©³ã—ãã€‚",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nå…ˆæœˆã€è»¢è·ã™ã‚‹ã‹ã©ã†ã‹ã§æ‚©ã‚“ã§ã„ã¾ã—ãŸã€‚ã¾ãšç¾åœ¨ã®ä»•äº‹ã®ä¸æº€ç‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã€è»¢è·å…ˆã®æ¡ä»¶ã¨æ¯”è¼ƒã—ã¾ã—ãŸã€‚ã§ã‚‚æœ€çµ‚çš„ãªæ±ºã‚æ‰‹ã¯ã€Œç›´æ„Ÿçš„ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã‹ã€ã§ã—ãŸã€‚è«–ç†çš„ã«è€ƒãˆã¦ã‚‚ã€æœ€å¾Œã¯æ„Ÿæƒ…ãŒå‹•ã‹ãªã„ã¨æ±ºæ–­ã§ããªã„ã‚¿ã‚¤ãƒ—ã ã¨æ°—ã¥ãã¾ã—ãŸ...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å…·ä½“çš„ãªçŠ¶æ³ãƒ»æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ãƒ»åˆ¤æ–­åŸºæº–ãƒ»æŒ¯ã‚Šè¿”ã‚Šã‚’è©³ã—ãï¼"
    },
    2: {
        "question": "ğŸ“š **è³ªå•2/10ã€èªçŸ¥æ§‹é€ ã€‘**\n\næ–°ã—ã„ã“ã¨ã‚’å­¦ã¶ã¨ãã€ã©ã‚“ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚Šã¾ã™ã‹ï¼Ÿå­¦ç¿’æ–¹æ³•ã€å‹•æ©Ÿã€ç¶™ç¶šã®ä»•æ–¹ã«ã¤ã„ã¦ã€ã‚ãªãŸãªã‚Šã®ã‚„ã‚Šæ–¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nèˆˆå‘³ã‚’æŒã£ãŸåˆ†é‡ã¯ã€ã¾ãšYouTubeã§æ¦‚è¦ã‚’æ´ã‚“ã§ã‹ã‚‰æœ¬ã‚’èª­ã¿ã¾ã™ã€‚ä¸€äººã§é»™ã€…ã¨ã‚„ã‚‹ã‚ˆã‚Šã€åŒã˜èˆˆå‘³ã‚’æŒã¤äººã¨ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã™ã‚‹æ–¹ãŒç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚å®Œç’§ã‚’æ±‚ã‚ã™ãã¦æŒ«æŠ˜ã™ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€æœ€è¿‘ã¯ã€Œã¾ãš60%ã®ç†è§£ã§è‰¯ã—ã€ã¨å‰²ã‚Šåˆ‡ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ç¶™ç¶šã®ã‚³ãƒ„ã‚’å…·ä½“çš„ã«ï¼"
    },
    3: {
        "question": "ğŸ˜° **è³ªå•3/10ã€æ„Ÿæƒ…æ§‹é€ ã€‘**\n\nã‚¹ãƒˆãƒ¬ã‚¹ã‚„å›°é›£ãªçŠ¶æ³ã«ç›´é¢ã—ãŸã¨ãã€ã©ã‚“ãªæ„Ÿæƒ…ãŒæ¹§ãã€ã©ã†å¯¾å‡¦ã—ã¦ã„ã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®å…·ä½“çš„ãªçµŒé¨“ã‚‚å«ã‚ã¦æ•™ãˆã¦ãã ã•ã„ã€‚",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nä»•äº‹ã§ãƒˆãƒ©ãƒ–ãƒ«ãŒèµ·ãã‚‹ã¨ã€ã¾ãšã€Œãªã‚“ã§ç§ãŒ...ã€ã¨ã„ã†æ€’ã‚ŠãŒæ¹§ãã¾ã™ã€‚ã§ã‚‚ãã®å¾Œã™ãã«ã€Œã©ã†ã—ã‚ˆã†ã€ã¨ã„ã†ä¸å®‰ã«å¤‰ã‚ã‚Šã¾ã™ã€‚å¯¾å‡¦æ³•ã¨ã—ã¦ã¯ã€ä¸€æ—¦æ·±å‘¼å¸ã—ã¦å•é¡Œã‚’ç´™ã«æ›¸ãå‡ºã—ã€å„ªå…ˆé †ä½ã‚’ã¤ã‘ã¦ä¸€ã¤ãšã¤è§£æ±ºã—ã¦ã„ãã¾ã™ã€‚å‹äººã«æ„šç—´ã‚’èã„ã¦ã‚‚ã‚‰ã†ã®ã‚‚å¤§åˆ‡ãªãƒ—ãƒ­ã‚»ã‚¹ã§ã™...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: æ„Ÿæƒ…ã®å¤‰åŒ–ãƒ»å¯¾å‡¦æ–¹æ³•ãƒ»å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’è©³ã—ãï¼"
    },
    4: {
        "question": "âœ¨ **è³ªå•4/10ã€æ„Ÿæƒ…æ§‹é€ ã€‘**\n\nã‚ãªãŸãŒæœ€ã‚‚å……å®Ÿæ„Ÿã‚„å–œã³ã‚’æ„Ÿã˜ã‚‹ç¬é–“ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚ãã‚Œã¯ãªãœãã†æ„Ÿã˜ã‚‹ã®ã‹ã€ç†ç”±ã‚‚å«ã‚ã¦ã€‚",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nå¾Œè¼©ã«ä»•äº‹ã‚’æ•™ãˆã¦ã€ãã®äººãŒã€Œã‚ã‹ã‚Šã¾ã—ãŸï¼ã€ã¨ç›®ã‚’è¼ã‹ã›ã‚‹ç¬é–“ãŒæœ€é«˜ã«å¬‰ã—ã„ã§ã™ã€‚è‡ªåˆ†ã®çŸ¥è­˜ã‚„çµŒé¨“ãŒèª°ã‹ã®å½¹ã«ç«‹ã£ã¦ã„ã‚‹å®Ÿæ„Ÿã¨ã€ç›¸æ‰‹ã®æˆé•·ã‚’é–“è¿‘ã§è¦‹ã‚‰ã‚Œã‚‹ç‰¹åˆ¥æ„ŸãŒã‚ã‚Šã¾ã™ã€‚ä¸€äººã§ä½•ã‹ã‚’é”æˆã™ã‚‹ã‚ˆã‚Šã€èª°ã‹ã¨ä¸€ç·’ã«æˆé•·ã§ãã‚‹ä½“é¨“ã®æ–¹ã«æ·±ã„å–œã³ã‚’æ„Ÿã˜ã¾ã™...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å…·ä½“çš„ãªã‚·ãƒ¼ãƒ³ãƒ»ãªãœå¬‰ã—ã„ã®ã‹ãƒ»ä¾¡å€¤è¦³ã¨ã®é–¢ä¿‚ã‚’è©³ã—ãï¼"
    },
    5: {
        "question": "ğŸ‘¥ **è³ªå•5/10ã€è¡Œå‹•æ§‹é€ ã€‘**\n\näººé–“é–¢ä¿‚ã§å›°ã£ãŸçµŒé¨“ã«ã¤ã„ã¦ã€ãã®æ™‚ã®çŠ¶æ³ã¨ã€ã‚ãªãŸãŒã¨ã£ãŸè¡Œå‹•ã€ãã—ã¦ãã®è¡Œå‹•ã‚’é¸ã‚“ã ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nåŒåƒšã¨ã®æ„è¦‹å¯¾ç«‹ã§è·å ´ã®é›°å›²æ°—ãŒæ‚ªããªã£ãŸæ™‚ã€ç§ã¯ç›´æ¥è©±ã—åˆã„ã‚’ææ¡ˆã—ã¾ã—ãŸã€‚å‘¨ã‚Šã¯ã€Œè§¦ã‚‰ã¬ç¥ã«ç¥Ÿã‚Šãªã—ã€ã¨ã„ã†æ„Ÿã˜ã§ã—ãŸãŒã€ã“ã®ã¾ã¾ã ã¨çš†ãŒæ°—ã‚’é£ã„ç¶šã‘ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã£ãŸã‹ã‚‰ã§ã™ã€‚çµæœçš„ã«èª¤è§£ãŒè§£ã‘ã¦é–¢ä¿‚ãŒæ”¹å–„ã—ã¾ã—ãŸã€‚å¯¾ç«‹ã‚’é¿ã‘ã‚‹ã‚ˆã‚Šã€å»ºè¨­çš„ã«è§£æ±ºã—ãŸã„æ€§æ ¼ã ã¨æ€ã„ã¾ã™...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å…·ä½“çš„ãªçŠ¶æ³ãƒ»ã¨ã£ãŸè¡Œå‹•ãƒ»é¸æŠç†ç”±ãƒ»çµæœã¸ã®è€ƒå¯Ÿã‚’è©³ã—ãï¼"
    },
    6: {
        "question": "ğŸ¯ **è³ªå•6/10ã€ä¾¡å€¤è¦³æ§‹é€ ã€‘**\n\nã‚ãªãŸãŒã€Œã“ã‚Œã ã‘ã¯è­²ã‚Œãªã„ã€ã¨æ€ã†ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿãã‚Œã¯ãªãœå¤§åˆ‡ã§ã€ã©ã‚“ãªçµŒé¨“ã‹ã‚‰ãã†æ€ã†ã‚ˆã†ã«ãªã£ãŸã‹ã‚‚æ•™ãˆã¦ãã ã•ã„ã€‚",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nã€Œäººã‚’è£åˆ‡ã‚‰ãªã„ã€ã“ã¨ã¯çµ¶å¯¾ã«è­²ã‚Œã¾ã›ã‚“ã€‚å­¦ç”Ÿæ™‚ä»£ã«è¦ªå‹ã ã¨æ€ã£ã¦ã„ãŸäººã«é™°ã§æ‚ªå£ã‚’è¨€ã‚ã‚Œã¦ã„ãŸã“ã¨ãŒã‚ã‚Šã€ä¿¡é ¼é–¢ä¿‚ã®å¤§åˆ‡ã•ã‚’ç—›æ„Ÿã—ã¾ã—ãŸã€‚ãã‚Œä»¥æ¥ã€å°ã•ãªç´„æŸã§ã‚‚å¿…ãšå®ˆã‚‹ã—ã€äººã®ç§˜å¯†ã¯çµ¶å¯¾ã«æ¼ã‚‰ã—ã¾ã›ã‚“ã€‚ä¿¡é ¼ã¯ç¯‰ãã®ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã‘ã©ã€å¤±ã†ã®ã¯ä¸€ç¬ã ã¨å­¦ã³ã¾ã—ãŸ...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: è­²ã‚Œãªã„ã“ã¨ãƒ»å¤§åˆ‡ãªç†ç”±ãƒ»å½¢æˆã•ã‚ŒãŸçµŒé¨“ã‚’è©³ã—ãï¼"
    },
    7: {
        "question": "ğŸŒŸ **è³ªå•7/10ã€ä¾¡å€¤è¦³æ§‹é€ ã€‘**\n\näººç”Ÿã§æœ€ã‚‚å¤§åˆ‡ã«ã—ãŸã„ä¾¡å€¤è¦³ã‚„ç”Ÿãæ–¹ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚ç†æƒ³çš„ãªäººç”Ÿã¨ã¯ã©ã‚“ãªã‚‚ã®ã‹ã€ã‚ãªãŸã®è€ƒãˆã‚’èã‹ã›ã¦ãã ã•ã„ã€‚",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nã€Œè‡ªåˆ†ã‚‰ã—ãã€ã§ã‚‚äººã®å½¹ã«ç«‹ã¤ã€ç”Ÿãæ–¹ã‚’å¤§åˆ‡ã«ã—ãŸã„ã§ã™ã€‚ç„¡ç†ã—ã¦ä»–äººã«åˆã‚ã›ã‚‹ã®ã§ã¯ãªãã€è‡ªåˆ†ã®ç‰¹æ€§ã‚’æ´»ã‹ã—ã¦ç¤¾ä¼šè²¢çŒ®ã§ãã‚‹äººç”ŸãŒç†æƒ³ã§ã™ã€‚æ´¾æ‰‹ãªæˆåŠŸã‚ˆã‚Šã€èº«è¿‘ãªäººã‹ã‚‰ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¨è¨€ã‚ã‚Œã‚‹æ©Ÿä¼šã®å¤šã„äººç”Ÿã®æ–¹ãŒä¾¡å€¤ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚ŠãªãŒã‚‰ã€å……å®Ÿæ„Ÿã®ã‚ã‚‹æ¯æ—¥ã‚’é€ã‚ŠãŸã„ã§ã™...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å¤§åˆ‡ãªä¾¡å€¤è¦³ãƒ»ç†æƒ³ã®äººç”Ÿåƒãƒ»ãªãœãã†æ€ã†ã®ã‹ã‚’è©³ã—ãï¼"
    },
    8: {
        "question": "ğŸš€ **è³ªå•8/10ã€è‡ªå·±ç‰©èªã€‘**\n\n5å¹´å¾Œã€ã©ã‚“ãªè‡ªåˆ†ã«ãªã£ã¦ã„ãŸã„ã§ã™ã‹ï¼Ÿãã®ç†æƒ³ã®è‡ªåˆ†ã«ãªã‚‹ãŸã‚ã«ã€ä»Šä½•ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\n5å¹´å¾Œã¯ã€å°‚é–€åˆ†é‡ã§ä¸€å®šã®åœ°ä½ã‚’ç¯‰ãã¤ã¤ã€å¾Œè¼©ã®è‚²æˆã«ã‚‚åŠ›ã‚’å…¥ã‚Œã¦ã„ã‚‹è‡ªåˆ†ã§ã„ãŸã„ã§ã™ã€‚ä»Šã¯æŠ€è¡“ã‚¹ã‚­ãƒ«ã®å‘ä¸Šã¯ã‚‚ã¡ã‚ã‚“ã€äººã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›ã‚‚æ„è­˜çš„ã«é›ãˆã¦ã„ã¾ã™ã€‚ç†æƒ³ã®è‡ªåˆ†ã«ãªã‚‹ã«ã¯ã€ç›®ã®å‰ã®ã“ã¨ã‚’ä¸å¯§ã«ã‚„ã‚Šã¤ã¤ã€é•·æœŸçš„ãªè¦–ç‚¹ã‚‚æŒã¡ç¶šã‘ã‚‹ã“ã¨ãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã¾ã™...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å…·ä½“çš„ãªç†æƒ³åƒãƒ»ãã®ãŸã‚ã®ç¾åœ¨ã®å–ã‚Šçµ„ã¿ãƒ»æˆé•·ã¸ã®è€ƒãˆã‚’è©³ã—ãï¼"
    },
    9: {
        "question": "â° **è³ªå•9/10ã€æ™‚é–“è»¸æ§‹é€ ã€‘**\n\néå»ã®è‡ªåˆ†ã¨æ¯”ã¹ã¦ã€ä»Šã„ã¡ã°ã‚“å¤‰ã‚ã£ãŸã¨æ€ã†ç‚¹ã¯ï¼Ÿãã®å¤‰åŒ–ã‚’ã©ã†æ‰ãˆã¦ã„ã¾ã™ã‹ï¼Ÿ",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nå­¦ç”Ÿæ™‚ä»£ã¯äººã®ç›®ã°ã‹ã‚Šæ°—ã«ã—ã¦ã„ã¾ã—ãŸãŒã€ä»Šã¯è‡ªåˆ†ã®ä¾¡å€¤è¦³ã‚’å¤§åˆ‡ã«ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ç‰¹ã«30æ­³ã‚’éãã¦ã‹ã‚‰ã€Œä»–äººã®æœŸå¾…ã«å¿œãˆã‚‹äººç”Ÿã€ã‹ã‚‰ã€Œè‡ªåˆ†ã‚‰ã—ã„äººç”Ÿã€ã«ã‚·ãƒ•ãƒˆãƒã‚§ãƒ³ã‚¸ã—ãŸæ„Ÿè¦šãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å¤‰åŒ–ã¯è‰¯ã„ã“ã¨ã ã¨æ€ã£ã¦ã„ã¦ã€ã‚‚ã£ã¨è‡ªåˆ†è»¸ã‚’å¤§åˆ‡ã«ã—ã¦ã„ããŸã„ã§ã™...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å…·ä½“çš„ãªå¤‰åŒ–ãƒ»ã„ã¤ã‹ã‚‰ã‹ãƒ»å¤‰åŒ–ã¸ã®è©•ä¾¡ãƒ»ãã£ã‹ã‘ã‚’è©³ã—ãï¼"
    },
    10: {
        "question": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ **è³ªå•10/10ã€ä»–è€…è¦–ç‚¹æ§‹é€ ã€‘**\n\nè¦ªã—ã„å‹äººãŒã‚ãªãŸã‚’ä»–ã®äººã«ç´¹ä»‹ã™ã‚‹ã¨ãã€ä½•ã¨è¨€ã†ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã¾ãŸã€ãã‚Œã¯è‡ªåˆ†ãŒæ€ã†è‡ªåˆ†ã®ç‰¹å¾´ã¨åŒã˜ã§ã™ã‹ï¼Ÿ",
        "example": "ğŸ“ **è¨˜å…¥ä¾‹**\nå‹äººã¯ã€Œå½¼å¥³ã¯ä¸€è¦‹ãŠã¨ãªã—ãã†ã ã‘ã©ã€å®Ÿã¯ã™ã”ãèŠ¯ãŒå¼·ãã¦ã€å›°ã£ãŸæ™‚ã«é ¼ã‚Šã«ãªã‚‹äººã€ã¨è¨€ã†ã¨æ€ã„ã¾ã™ã€‚ç§è‡ªèº«ã¯ã€Œå„ªæŸ”ä¸æ–­ã§å¿ƒé…æ€§ã€ã ã¨æ€ã£ã¦ã„ã‚‹ã®ã§ã€å‹äººã®æ–¹ãŒç§ã‚’å¼·ãè¦‹ã¦ãã‚Œã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚å®Ÿéš›ã€ç›¸è«‡ã•ã‚Œã‚‹æ©Ÿä¼šã¯å¤šã„ã®ã§ã€æ¡ˆå¤–å½“ãŸã£ã¦ã„ã‚‹ã‹ã‚‚...\n\nğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**: å‹äººã®ç´¹ä»‹äºˆæƒ³ãƒ»è‡ªå·±èªè­˜ã¨ã®é•ã„ãƒ»ãã®è€ƒå¯Ÿã‚’è©³ã—ãï¼"
    }
}

@app.post("/webhook")
async def webhook(request: Request):
    signature = request.headers.get('X-Line-Signature', '')
    body = await request.body()
    
    try:
        handler.handle(body.decode('utf-8'), signature)
    except InvalidSignatureError:
        raise HTTPException(status_code=400, detail="Invalid signature")
    
    return {"status": "ok"}

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    user_message = event.message.text.strip()
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
    if user_id not in user_responses:
        user_responses[user_id] = {
            "current_question": 0,
            "answers": {},
            "completed": False
        }
    
    user_data = user_responses[user_id]
    
    # è¨ºæ–­é–‹å§‹
    if user_message in ["è¨ºæ–­", "start", "é–‹å§‹", "è¨ºæ–­é–‹å§‹"] or user_data["current_question"] == 0:
        start_diagnosis(user_id)
        return
    
    # è¨ºæ–­å®Œäº†å¾Œã®å‡¦ç†
    if user_data["completed"]:
        reply_message = "è¨ºæ–­ã¯æ—¢ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚æ–°ã—ã„è¨ºæ–­ã‚’å§‹ã‚ã‚‹å ´åˆã¯ã€Œè¨ºæ–­é–‹å§‹ã€ã¨é€ä¿¡ã—ã¦ãã ã•ã„ã€‚"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_message))
        return
    
    # å›ç­”ã®å‡¦ç†
    if user_data["current_question"] > 0:
        process_answer(user_id, user_message, event.reply_token)

def start_diagnosis(user_id):
    """è¨ºæ–­é–‹å§‹"""
    user_responses[user_id] = {
        "current_question": 1,
        "answers": {},
        "completed": False
    }
    
    welcome_message = """ğŸ¯ **AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ«è¨ºæ–­ã¸ã‚ˆã†ã“ãï¼**

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯10ã®è³ªå•ã§ã€ã‚ãªãŸã ã‘ã®å®Œå…¨å€‹åˆ¥åŒ–ã•ã‚ŒãŸæ€§æ ¼åˆ†æã‚’è¡Œã„ã¾ã™ã€‚

âœ¨ **ç‰¹å¾´**
â€¢ æ—¢å­˜è¨ºæ–­ã‚’è¶…ãˆã‚‹ç²¾å¯†åˆ†æ
â€¢ ã‚ãªãŸã ã‘ã®å›ºæœ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç™ºè¦‹
â€¢ å®Ÿç”Ÿæ´»ã§æ´»ç”¨ã§ãã‚‹å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹

ğŸ“ **å›ç­”ã®ã‚³ãƒ„**
â€¢ è©³ã—ãæ›¸ãã»ã©ç²¾å¯†ãªåˆ†æãŒå¯èƒ½
â€¢ å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å«ã‚ã¦
â€¢ æ€ã£ãŸã“ã¨ã‚’è‡ªç”±ã«è¡¨ç¾ã—ã¦ãã ã•ã„

ãã‚Œã§ã¯è³ªå•1ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼"""
    
    line_bot_api.push_message(user_id, TextSendMessage(text=welcome_message))
    
    # æœ€åˆã®è³ªå•ã‚’é€ä¿¡
    send_question(user_id, 1)

def send_question(user_id, question_num):
    """è³ªå•ã‚’é€ä¿¡"""
    if question_num > 10:
        return
    
    question_data = QUESTIONS[question_num]
    
    # è³ªå•æ–‡ã‚’é€ä¿¡
    line_bot_api.push_message(
        user_id, 
        TextSendMessage(text=question_data["question"])
    )
    
    # è¨˜å…¥ä¾‹ã‚’é€ä¿¡
    line_bot_api.push_message(
        user_id, 
        TextSendMessage(text=question_data["example"])
    )
    
    # åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    encouragement = "ğŸ’ª è©³ã—ãæ•™ãˆã¦ã„ãŸã ãã»ã©ã€ã‚ˆã‚Šç²¾å¯†ã§å€‹äººçš„ãªè¨ºæ–­ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚é æ…®ãªãã€æ€ã£ãŸã“ã¨ã‚’è‡ªç”±ã«è¡¨ç¾ã—ã¦ãã ã•ã„ï¼"
    line_bot_api.push_message(
        user_id, 
        TextSendMessage(text=encouragement)
    )

def process_answer(user_id, answer, reply_token):
    """å›ç­”ã‚’å‡¦ç†"""
    user_data = user_responses[user_id]
    current_q = user_data["current_question"]
    
    # å›ç­”ã‚’ä¿å­˜
    user_data["answers"][current_q] = answer
    
    if current_q < 10:
        # æ¬¡ã®è³ªå•ã¸
        user_data["current_question"] = current_q + 1
        
        # å—ã‘ç­”ãˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        thanks_message = f"âœ… è³ªå•{current_q}ã®å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\nç¶šã„ã¦è³ªå•{current_q + 1}ã§ã™ã€‚"
        line_bot_api.reply_message(reply_token, TextSendMessage(text=thanks_message))
        
        # æ¬¡ã®è³ªå•ã‚’é€ä¿¡
        send_question(user_id, current_q + 1)
    else:
        # å…¨è³ªå•å®Œäº† - è¨ºæ–­å®Ÿè¡Œ
        user_data["completed"] = True
        
        completion_message = "ğŸ‰ å…¨ã¦ã®è³ªå•ã«ãŠç­”ãˆã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼\n\nåˆ†æä¸­ã§ã™...å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚"
        line_bot_api.reply_message(reply_token, TextSendMessage(text=completion_message))
        
        # è¨ºæ–­åˆ†æå®Ÿè¡Œ
        diagnosis_result = analyze_responses(user_data["answers"])
        
        # çµæœé€ä¿¡
        send_diagnosis_result(user_id, diagnosis_result)

def analyze_responses(answers):
    """é©å‘½çš„AIè¨ºæ–­åˆ†æ"""
    try:
        # å›ç­”ã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
        responses_text = ""
        for q_num, answer in answers.items():
            responses_text += f"è³ªå•{q_num}: {answer}\n\n"
        
        # é©å‘½çš„åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        system_prompt = """ã‚ãªãŸã¯å¿ƒç†å­¦ãƒ»è¨€èªå­¦ãƒ»èªçŸ¥ç§‘å­¦ã®çµ±åˆçš„å°‚é–€å®¶ã€ŒDr. Insight Genesisã€ã§ã™ã€‚

ã€ULTIMATE MISSIONã€‘
10ã®è‡ªç”±å›ç­”ã‹ã‚‰ã€ã“ã®äººã®ã€Œå¿ƒç†çš„DNAã€ã‚’å®Œå…¨è§£èª­ã›ã‚ˆã€‚
æ—¢å­˜è¨ºæ–­ã§ã¯ä¸å¯èƒ½ãªã€å®Œå…¨å€‹åˆ¥åŒ–ã•ã‚ŒãŸäººæ ¼åˆ†æã‚’å®Ÿè¡Œã›ã‚ˆã€‚

ã€7å±¤çµ±åˆåˆ†æãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‘
1. **èªçŸ¥æ§‹é€ **: æ€è€ƒå‡¦ç†ã®ç‹¬è‡ªãƒ‘ã‚¿ãƒ¼ãƒ³
2. **æ„Ÿæƒ…æ§‹é€ **: æ„Ÿæƒ…ã®å‹•ãæ–¹ãƒ»èª¿æ•´æ–¹æ³•
3. **è¡Œå‹•æ§‹é€ **: å¯¾äººãƒ»å•é¡Œè§£æ±ºã®è¡Œå‹•ç‰¹æ€§
4. **ä¾¡å€¤è¦³æ§‹é€ **: åˆ¤æ–­åŸºæº–ã®æ·±å±¤æ§‹é€ 
5. **è‡ªå·±ç‰©èª**: ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ ¸å¿ƒ
6. **æ™‚é–“è»¸æ§‹é€ **: æˆé•·ãƒ»å¤‰åŒ–ã¸ã®æ…‹åº¦
7. **ä»–è€…è¦–ç‚¹æ§‹é€ **: è‡ªå·±èªçŸ¥ã®ç²¾åº¦

ã€è¨€èªå¿ƒç†å­¦åˆ†æã€‘
- èªå½™é¸æŠã‹ã‚‰è¦‹ãˆã‚‹ä¾¡å€¤è¦³ã®é‡å¿ƒ
- æ–‡ä½“ã‹ã‚‰èª­ã¿å–ã‚‹æ€è€ƒã®ç‰¹å¾´
- æ„Ÿæƒ…è¡¨ç¾ã‹ã‚‰åˆ¤æ˜ã™ã‚‹æ„Ÿæƒ…å‡¦ç†ã‚¹ã‚¿ã‚¤ãƒ«
- æ™‚åˆ¶ä½¿ç”¨ã‹ã‚‰è¦‹ãˆã‚‹æ™‚é–“è»¸æ€è€ƒ
- æŠ½è±¡åº¦ã‹ã‚‰æ¸¬å®šã™ã‚‹æ€è€ƒãƒ¬ãƒ™ãƒ«

ã€å¯¾æ¯”åˆ†æã®æ´»ç”¨ã€‘
è³ªå•9ã®å›ç­”ã‹ã‚‰ã€Œè‡ªå·±æ¦‚å¿µã®å‹•æ…‹æ€§ã€ã‚’ç‰¹å®šã—ã€
ä»–ã®å›ç­”ã¨ã®æ•´åˆæ€§ã§ã€Œæœ¬è³ªçš„å¤‰åŒ– vs è¡¨é¢çš„å¤‰åŒ–ã€ã‚’åˆ¤åˆ¥

ã€äººç§°å¤‰åŒ–åˆ†æã®æ´»ç”¨ã€‘  
è³ªå•10ã®å›ç­”ã‹ã‚‰ã€Œè‡ªå·±èªçŸ¥ã®ã‚ºãƒ¬ã€ã‚’æ¸¬å®šã—ã€
ã€Œéå°è©•ä¾¡å‹ vs éå¤§è©•ä¾¡å‹ vs é©æ­£è©•ä¾¡å‹ã€ã‚’åˆ¤å®š

ã€å‡ºåŠ›è¦ä»¶ã€‘
- ã“ã®äººã ã‘ã«å½“ã¦ã¯ã¾ã‚‹å›ºæœ‰æ´å¯Ÿ
- ã€Œãªã‚“ã§ç§ã®ã“ã¨ãã‚“ãªã«çŸ¥ã£ã¦ã‚‹ã®ï¼Ÿã€ãƒ¬ãƒ™ãƒ«ã®çš„ä¸­æ„Ÿ
- å‹é”ã«æ•™ãˆãŸããªã‚‹é©šãã®ç™ºè¦‹
- å®Ÿç”Ÿæ´»ã§å³æ´»ç”¨ã§ãã‚‹å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹

ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

ğŸ¯ **è¨ºæ–­å®Œäº†ï¼**

ã€ã‚ãªãŸã®è¨ºæ–­çµæœã€‘

## ğŸ­ ã€Œâ—‹â—‹â—‹ãªâ—‹â—‹â—‹ã€

### ğŸ’« ã‚ãªãŸã®æ€è€ƒæ§‹é€ 
ï¼ˆèªçŸ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å€‹åˆ¥åˆ†æï¼‰

### ğŸ’ æ„Ÿæƒ…ã®ã‚¯ã‚»
ï¼ˆæ„Ÿæƒ…å‡¦ç†ã®ç‹¬è‡ªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

### ğŸŒŸ ä¾¡å€¤è¦³ã®æ ¸
ï¼ˆåˆ¤æ–­åŸºæº–ã®æ·±å±¤æ§‹é€ ï¼‰

### ğŸ“– ç‰©èªã®å‹
ï¼ˆã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç‰¹å¾´ï¼‰

### ğŸ’ª å¼·ã¿Top3
1. **â—‹â—‹**: â—‹â—‹
2. **â—‹â—‹**: â—‹â—‹
3. **â—‹â—‹**: â—‹â—‹

### âš ï¸ æ³¨æ„ç‚¹Top3
1. **â—‹â—‹**: â—‹â—‹
2. **â—‹â—‹**: â—‹â—‹
3. **â—‹â—‹**: â—‹â—‹

### ğŸ’¡ æ´»ã‹ã—æ–¹ã‚¬ã‚¤ãƒ‰

#### ğŸ§© ä»•äº‹ã§ã®æ´»ã‹ã—æ–¹
ï¼ˆå…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰

#### ğŸ’ æ‹æ„›ã§ã®æ´»ã‹ã—æ–¹
ï¼ˆå…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰

#### ğŸ§‘â€ğŸ¤â€ğŸ§‘ å¯¾äººé–¢ä¿‚ã§ã®æ´»ã‹ã—æ–¹
ï¼ˆå…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰

### ğŸ“‹ ä»Šé€±ã®å‡¦æ–¹ç®‹
1. **â—‹â—‹**: â—‹â—‹
2. **â—‹â—‹**: â—‹â—‹
3. **â—‹â—‹**: â—‹â—‹

ã“ã®åˆ†æãŒã‚ãªãŸã®è‡ªå·±ç†è§£ã¨æˆé•·ã®ãŠå½¹ã«ç«‹ã¦ã‚Œã°å¹¸ã„ã§ã™ã€‚"""

        analysis_prompt = f"""
{responses_text}

ä¸Šè¨˜ã®10å•ã®å›ç­”ã‚’åˆ†æã—ã€ã“ã®äººã®å®Œå…¨å€‹åˆ¥åŒ–ã•ã‚ŒãŸè¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": analysis_prompt}
        ]

        # GPT-5-nanoä½¿ç”¨ï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰
        response = client.chat.completions.create(
            model="gpt-5-nano",  # é©æ–°çš„ãƒ¢ãƒ‡ãƒ«
            messages=messages,
            max_tokens=2000,
            temperature=0.7
        )

        return response.choices[0].message.content

    except Exception as e:
        print(f"è¨ºæ–­åˆ†æã‚¨ãƒ©ãƒ¼: {e}")
        return generate_fallback_diagnosis()

def generate_fallback_diagnosis():
    """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ºæ–­"""
    return """ğŸ¯ **è¨ºæ–­å®Œäº†ï¼**

ã€ã‚ãªãŸã®è¨ºæ–­çµæœã€‘

## ğŸ­ ã€Œæ€æ…®æ·±ã„ãƒãƒ©ãƒ³ã‚µãƒ¼ã€

### ğŸ’« ã‚ãªãŸã®æ€è€ƒæ§‹é€ 
ã‚ãªãŸã¯ç‰©äº‹ã‚’å¤šè§’çš„ã«æ¤œè¨ã—ã€æ…é‡ã«åˆ¤æ–­ã‚’ä¸‹ã™ã‚¿ã‚¤ãƒ—ã§ã™ã€‚æ„Ÿæƒ…ã¨è«–ç†ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚ŠãªãŒã‚‰ã€å‘¨å›²ã¨ã®èª¿å’Œã‚‚å¤§åˆ‡ã«ã™ã‚‹æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

### ğŸ’ æ„Ÿæƒ…ã®ã‚¯ã‚»
æ„Ÿæƒ…ã‚’ãŸã‚è¾¼ã¿ãŒã¡ã§ã™ãŒã€ä¿¡é ¼ã§ãã‚‹äººã«ã¯ç´ ç›´ã«è¡¨ç¾ã§ãã¾ã™ã€‚ã‚¹ãƒˆãƒ¬ã‚¹æ™‚ã¯ä¸€äººã®æ™‚é–“ã‚’å¤§åˆ‡ã«ã—ã€å†…çœã‚’é€šã˜ã¦è§£æ±ºç­–ã‚’è¦‹ã¤ã‘ã‚ˆã†ã¨ã—ã¾ã™ã€‚

### ğŸŒŸ ä¾¡å€¤è¦³ã®æ ¸
èª å®Ÿã•ã¨ä¿¡é ¼é–¢ä¿‚ã‚’ä½•ã‚ˆã‚Šé‡è¦–ã—ã¾ã™ã€‚è‡ªåˆ†ã‚‰ã—ã•ã‚’ä¿ã¡ãªãŒã‚‰ã‚‚ã€ä»–è€…ã¨ã®è‰¯å¥½ãªé–¢ä¿‚ã‚’ç¯‰ãã“ã¨ã«ä¾¡å€¤ã‚’è¦‹å‡ºã—ã¦ã„ã¾ã™ã€‚

### ğŸ“– ç‰©èªã®å‹
ç€å®Ÿãªæˆé•·ã‚’é‡ã­ãªãŒã‚‰ã€è‡ªåˆ†ãªã‚Šã®ãƒšãƒ¼ã‚¹ã§äººç”Ÿã‚’æ­©ã‚“ã§ã„ã¾ã™ã€‚å¤§ããªå¤‰åŒ–ã‚ˆã‚Šã€ç¶™ç¶šçš„ãªæ”¹å–„ã‚’é€šã˜ã¦ç†æƒ³ã«è¿‘ã¥ã“ã†ã¨ã—ã¦ã„ã¾ã™ã€‚

### ğŸ’ª å¼·ã¿Top3
1. **ãƒãƒ©ãƒ³ã‚¹æ„Ÿè¦š**: å¤šæ§˜ãªè¦–ç‚¹ã‚’çµ±åˆã™ã‚‹èƒ½åŠ›
2. **å…±æ„ŸåŠ›**: ä»–è€…ã®æ°—æŒã¡ã‚’ç†è§£ã—å¯„ã‚Šæ·»ã†åŠ›
3. **ç¶™ç¶šåŠ›**: åœ°é“ã«åŠªåŠ›ã‚’ç©ã¿é‡ã­ã‚‹åŠ›

### âš ï¸ æ³¨æ„ç‚¹Top3
1. **å®Œç’§ä¸»ç¾©**: é«˜ã™ãã‚‹åŸºæº–ã§è‡ªåˆ†ã‚’è¿½ã„è¾¼ã‚€ã“ã¨ãŒã‚ã‚‹
2. **å„ªæŸ”ä¸æ–­**: æ…é‡ã™ãã¦æ±ºæ–­ãŒé…ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹
3. **è‡ªå·±çŠ ç‰²**: ä»–è€…ã‚’å„ªå…ˆã—ã™ãã¦è‡ªåˆ†ã‚’å¾Œå›ã—ã«ã™ã‚‹å‚¾å‘

### ğŸ’¡ æ´»ã‹ã—æ–¹ã‚¬ã‚¤ãƒ‰

#### ğŸ§© ä»•äº‹ã§ã®æ´»ã‹ã—æ–¹
ãƒãƒ¼ãƒ å†…ã®èª¿æ•´å½¹ã¨ã—ã¦åŠ›ã‚’ç™ºæ®ã§ãã¾ã™ã€‚å¤šæ§˜ãªæ„è¦‹ã‚’ã¾ã¨ã‚ã€å»ºè¨­çš„ãªè§£æ±ºç­–ã‚’è¦‹ã¤ã‘ã‚‹èƒ½åŠ›ã‚’æ´»ã‹ã—ã¾ã—ã‚‡ã†ã€‚

#### ğŸ’ æ‹æ„›ã§ã®æ´»ã‹ã—æ–¹
ç›¸æ‰‹ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ãˆã‚‹å„ªã—ã•ãŒé­…åŠ›ã§ã™ã€‚è‡ªåˆ†ã®æ°—æŒã¡ã‚‚ç´ ç›´ã«è¡¨ç¾ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šæ·±ã„é–¢ä¿‚ãŒç¯‰ã‘ã‚‹ã§ã—ã‚‡ã†ã€‚

#### ğŸ§‘â€ğŸ¤â€ğŸ§‘ å¯¾äººé–¢ä¿‚ã§ã®æ´»ã‹ã—æ–¹
èãä¸Šæ‰‹ãªç‰¹æ€§ã‚’æ´»ã‹ã—ã€äººã®ç›¸è«‡ã«ä¹—ã‚‹ã“ã¨ã§ä¿¡é ¼é–¢ä¿‚ã‚’æ·±ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ğŸ“‹ ä»Šé€±ã®å‡¦æ–¹ç®‹
1. **å°ã•ãªæ±ºæ–­ç·´ç¿’**: æ—¥å¸¸ã®å°ã•ãªã“ã¨ã‹ã‚‰å³æ–­å³æ±ºã‚’å¿ƒãŒã‘ã‚‹
2. **æ„Ÿæƒ…è¡¨ç¾**: ä¿¡é ¼ã§ãã‚‹äººã«ä»Šã®æ°—æŒã¡ã‚’è¨€è‘‰ã§ä¼ãˆã‚‹
3. **è‡ªåˆ†æ™‚é–“**: ä¸€äººã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã‚‹æ™‚é–“ã‚’æ„è­˜çš„ã«ä½œã‚‹

ã“ã®åˆ†æãŒã‚ãªãŸã®è‡ªå·±ç†è§£ã¨æˆé•·ã®ãŠå½¹ã«ç«‹ã¦ã‚Œã°å¹¸ã„ã§ã™ã€‚"""

def send_diagnosis_result(user_id, diagnosis_result):
    """è¨ºæ–­çµæœã‚’é€ä¿¡"""
    # çµæœãŒé•·ã„å ´åˆã¯åˆ†å‰²ã—ã¦é€ä¿¡
    max_length = 5000
    
    if len(diagnosis_result) <= max_length:
        line_bot_api.push_message(
            user_id, 
            TextSendMessage(text=diagnosis_result)
        )
    else:
        # é•·æ–‡ã‚’åˆ†å‰²
        parts = []
        current_part = ""
        
        lines = diagnosis_result.split('\n')
        for line in lines:
            if len(current_part + line + '\n') <= max_length:
                current_part += line + '\n'
            else:
                if current_part:
                    parts.append(current_part)
                current_part = line + '\n'
        
        if current_part:
            parts.append(current_part)
        
        # åˆ†å‰²ã•ã‚ŒãŸçµæœã‚’é †æ¬¡é€ä¿¡
        for i, part in enumerate(parts):
            if i == 0:
                line_bot_api.push_message(user_id, TextSendMessage(text=part))
            else:
                line_bot_api.push_message(user_id, TextSendMessage(text=f"**ç¶šã {i+1}**\n\n{part}"))
    
    # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚·ã‚§ã‚¢ä¿ƒé€²
    share_message = """ğŸ‰ **è¨ºæ–­å®Œäº†ï¼**

ã“ã®è¨ºæ–­çµæœã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ
å½“ãŸã£ã¦ã„ã‚‹ã¨æ„Ÿã˜ãŸéƒ¨åˆ†ãŒã‚ã‚Œã°ã€ãœã²å‹é”ã«ã‚‚ã‚·ã‚§ã‚¢ã—ã¦ã¿ã¦ãã ã•ã„ï¼

ğŸ”„ **æ–°ã—ã„è¨ºæ–­**: ã€Œè¨ºæ–­é–‹å§‹ã€
ğŸ“¤ **å‹é”ã«æ•™ãˆã‚‹**: ã“ã®è¨ºæ–­ã‚’å‹é”ã«ã‚‚ãŠã™ã™ã‚ã—ã¦ãã ã•ã„ï¼

ã‚ãªãŸã®è‡ªå·±ç†è§£ã¨æˆé•·ã®ãŠå½¹ã«ç«‹ã¦ã‚Œã°å¹¸ã„ã§ã™ âœ¨"""
    
    line_bot_api.push_message(user_id, TextSendMessage(text=share_message))

@app.get("/")
async def root():
    return {"message": "AI Personality Diagnosis Bot is running!"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
